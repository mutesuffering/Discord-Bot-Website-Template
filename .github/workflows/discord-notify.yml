name: Discord Notifications (Embed - GitHub style)

on:
  push:

jobs:
  discord_embed:
    runs-on: ubuntu-latest
    steps:
      - name: Send commits as Discord embed
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail

          EVENT_FILE="$GITHUB_EVENT_PATH"
          REPO="${{ github.repository }}"
          REF="${{ github.ref }}"
          BRANCH="${REF##*/}"
          ACTOR="${{ github.actor }}"
          AVATAR_URL="https://github.com/${ACTOR}.png"
          COMMITS_COUNT=$(jq '.commits | length' "$EVENT_FILE" 2>/dev/null || echo 0)

          if [ "$COMMITS_COUNT" -eq 0 ]; then
            if jq -e '.head_commit' "$EVENT_FILE" >/dev/null 2>&1; then
              COMMITS_COUNT=1
              jq '[.head_commit] | {commits: .}' "$EVENT_FILE" > /tmp/evt && EVENT_FILE=/tmp/evt
            fi
          fi

          TITLE="[$REPO:$BRANCH] ${COMMITS_COUNT} new commit(s)"

          DESC=""
          MAX=5
          for i in $(seq 0 $((COMMITS_COUNT-1))); do
            if [ "$i" -ge "$MAX" ]; then break; fi

            COMMIT_ID=$(jq -r ".commits[$i].id // .commits[$i].sha" "$EVENT_FILE")
            SHORT_ID=$(printf "%.7s" "$COMMIT_ID")
            COMMIT_URL=$(jq -r ".commits[$i].url // empty" "$EVENT_FILE")
            [ -z "$COMMIT_URL" ] || [ "$COMMIT_URL" = "null" ] && COMMIT_URL="https://github.com/${REPO}/commit/${COMMIT_ID}"
            COMMIT_MSG=$(jq -r ".commits[$i].message" "$EVENT_FILE" | tr -d '\r' | awk '{gsub(/\n/, " "); print}')
            COMMIT_AUTHOR=$(jq -r ".commits[$i].author.name // .commits[$i].author.username // .commits[$i].author.email // \"${ACTOR}\"" "$EVENT_FILE")

            SAFE_MSG=$(echo "$COMMIT_MSG" | sed 's/"/\\"/g')
            # add a REAL newline
            DESC="${DESC}[\`${SHORT_ID}\`](${COMMIT_URL}) ${SAFE_MSG} â€“ ${COMMIT_AUTHOR}\\n"
          done

          [ -z "$DESC" ] && DESC="No commit details available."

          # Discord expects actual newline characters, so convert \\n to \n in JSON safely
          DESC_CLEAN=$(echo -e "$DESC")

          JSON_PAYLOAD=$(jq -n \
            --arg author "$ACTOR" \
            --arg avatar "$AVATAR_URL" \
            --arg title "$TITLE" \
            --arg desc "$DESC_CLEAN" \
            --arg repo_url "https://github.com/${REPO}/commits/${BRANCH}" \
            '{
              embeds: [
                {
                  author: { name: $author, icon_url: $avatar },
                  title: $title,
                  url: $repo_url,
                  description: $desc,
                  color: 3447003
                }
              ]
            }')

          curl -sS -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" "$DISCORD_WEBHOOK"
